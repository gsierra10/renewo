name: CI Unit Tests

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

jobs:
  unit-tests:
    runs-on: macos-14
    env:
      MIN_COVERAGE: ""
      UPLOAD_COVERAGE_ARTIFACT: "false"

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Select latest stable Xcode
        shell: bash
        run: |
          set -euo pipefail

          xcode_app="$(find /Applications -maxdepth 1 -type d -name 'Xcode*.app' | grep -viE 'beta|rc' | sort -V | tail -n 1 || true)"
          if [[ -z "${xcode_app}" ]]; then
            xcode_app="/Applications/Xcode.app"
          fi

          sudo xcode-select -s "${xcode_app}/Contents/Developer"
          xcodebuild -version

      - name: Resolve Swift package dependencies
        shell: bash
        run: |
          set -euo pipefail
          xcodebuild \
            -project Renewo.xcodeproj \
            -scheme Renewo \
            -resolvePackageDependencies

      - name: Select iOS simulator destination
        id: simulator
        shell: bash
        run: |
          set -euo pipefail

          simctl_output="$(xcrun simctl list devices available)"

          preferred_names=(
            "iPhone 16"
            "iPhone 15"
            "iPhone 14"
            "iPhone SE (3rd generation)"
          )

          chosen_id=""
          chosen_name=""

          pick_udid_for_name() {
            local device_name="$1"
            printf '%s\n' "$simctl_output" | awk -v target="$device_name" '
              index($0, target " (") > 0 {
                if (match($0, /\(([0-9A-Fa-f-]{36})\)/)) {
                  print substr($0, RSTART + 1, RLENGTH - 2)
                  exit
                }
              }'
          }

          for preferred in "${preferred_names[@]}"; do
            candidate_id="$(pick_udid_for_name "$preferred")"
            if [[ -n "$candidate_id" ]]; then
              chosen_id="$candidate_id"
              chosen_name="$preferred"
              break
            fi
          done

          if [[ -z "$chosen_id" ]]; then
            chosen_id="$(printf '%s\n' "$simctl_output" | awk '
              /^[[:space:]]*iPhone / {
                if (match($0, /\(([0-9A-Fa-f-]{36})\)/)) {
                  print substr($0, RSTART + 1, RLENGTH - 2)
                  exit
                }
              }')"
            chosen_name="first available iPhone"
          fi

          if [[ -z "$chosen_id" ]]; then
            chosen_id="$(printf '%s\n' "$simctl_output" | awk '
              /^[[:space:]]*iP(hone|ad) / {
                if (match($0, /\(([0-9A-Fa-f-]{36})\)/)) {
                  print substr($0, RSTART + 1, RLENGTH - 2)
                  exit
                }
              }')"
            chosen_name="first available iOS simulator"
          fi

          if [[ -z "$chosen_id" ]]; then
            echo "No available iOS Simulator devices found via simctl."
            echo "$simctl_output"
            exit 1
          fi

          echo "Using simulator: $chosen_name ($chosen_id)"
          echo "destination=id=$chosen_id" >> "$GITHUB_OUTPUT"

      - name: Run unit tests
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p TestResults

          if command -v xcpretty >/dev/null 2>&1; then
            xcodebuild \
              -project Renewo.xcodeproj \
              -scheme Renewo \
              -destination "${{ steps.simulator.outputs.destination }}" \
              -only-testing:RenewoTests \
              -enableCodeCoverage YES \
              -resultBundlePath TestResults/UnitTests.xcresult \
              test | xcpretty
          else
            xcodebuild \
              -project Renewo.xcodeproj \
              -scheme Renewo \
              -destination "${{ steps.simulator.outputs.destination }}" \
              -only-testing:RenewoTests \
              -enableCodeCoverage YES \
              -resultBundlePath TestResults/UnitTests.xcresult \
              test
          fi

      - name: Generate coverage summary
        if: success()
        shell: bash
        run: |
          set -euo pipefail
          ./scripts/coverage-summary.sh TestResults/UnitTests.xcresult | tee TestResults/coverage-summary.md

      - name: Enforce coverage threshold
        if: env.MIN_COVERAGE != ''
        shell: bash
        run: |
          set -euo pipefail

          coverage=$(awk -F': ' '/Overall line coverage:/ {gsub(/%/, "", $2); print $2}' TestResults/coverage-summary.md)
          if [[ -z "$coverage" ]]; then
            echo "ERROR: Unable to parse coverage summary." >&2
            exit 1
          fi

          python3 - <<PY "$coverage" "$MIN_COVERAGE"
import sys
coverage = float(sys.argv[1])
minimum = float(sys.argv[2])
if coverage + 1e-9 < minimum:
    raise SystemExit(f\"Coverage {coverage:.1f}% is below the required minimum {minimum:.1f}%\")
print(f\"Coverage {coverage:.1f}% meets the minimum {minimum:.1f}%\")
PY

      - name: Upload unit test result bundle on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: unit-tests-xcresult
          path: TestResults/UnitTests.xcresult
          retention-days: 7
          if-no-files-found: warn

      - name: Upload unit test result bundle on success (optional)
        if: success() && env.UPLOAD_COVERAGE_ARTIFACT == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: unit-tests-xcresult
          path: TestResults/UnitTests.xcresult
          retention-days: 7
          if-no-files-found: warn
