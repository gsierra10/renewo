name: CI Build Release

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

jobs:
  build-release:
    name: Build Release configuration
    runs-on: macos-14

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Select latest stable Xcode
        shell: bash
        run: |
          set -euo pipefail

          xcode_app="$(find /Applications -maxdepth 1 -type d -name 'Xcode*.app' | grep -viE 'beta|rc' | sort -V | tail -n 1 || true)"
          if [[ -z "${xcode_app}" ]]; then
            xcode_app="/Applications/Xcode.app"
          fi

          sudo xcode-select -s "${xcode_app}/Contents/Developer"
          xcodebuild -version

      - name: Resolve Swift package dependencies
        shell: bash
        run: |
          set -euo pipefail
          xcodebuild \
            -project Renewo.xcodeproj \
            -scheme Renewo \
            -resolvePackageDependencies

      - name: Build Release
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p BuildResults

          if command -v xcpretty >/dev/null 2>&1; then
            xcodebuild \
              -project Renewo.xcodeproj \
              -scheme Renewo \
              -configuration Release \
              -destination 'generic/platform=iOS Simulator' \
              CODE_SIGNING_ALLOWED=NO \
              CODE_SIGNING_REQUIRED=NO \
              -resultBundlePath BuildResults/ReleaseBuild.xcresult \
              build | xcpretty
          else
            xcodebuild \
              -project Renewo.xcodeproj \
              -scheme Renewo \
              -configuration Release \
              -destination 'generic/platform=iOS Simulator' \
              CODE_SIGNING_ALLOWED=NO \
              CODE_SIGNING_REQUIRED=NO \
              -resultBundlePath BuildResults/ReleaseBuild.xcresult \
              build
          fi

      - name: Upload release build result bundle on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: release-build-xcresult
          path: BuildResults/ReleaseBuild.xcresult
          retention-days: 7
          if-no-files-found: warn
